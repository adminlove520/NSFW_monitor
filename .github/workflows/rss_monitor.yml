
name: RSS Monitor

on:
  schedule:
    # 每2小时运行一次
    - cron: '0 */1 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'rss.yaml'
      - '.github/workflows/**'

jobs:
  monitor:
    runs-on: ubuntu-latest
    # timeout-minutes: 60 # Once 模式移除
    permissions:
      contents: write  # 允许写入仓库内容(提交db)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run RSS Monitor (Once Mode)
      env:
        # 从 Secrets 获取 Discord Webhook
        DISCARD_WEBHOOK: ${{ secrets.DISCARD_WEBHOOK }}
        # 强制开启 Discord 推送开关
        DISCARD_SWITCH: "ON"
        # 确保其他不需要的推送关闭 (如果 config.yaml 里默认开启了)
        DINGDING_SWITCH: "OFF"
        FEISHU_SWITCH: "OFF"
        TELEGRAM_SWITCH: "OFF"
      run: |
        # 切换到单次运行模式
        python Rss_monitor.py --once

    - name: Commit Database Changes
      if: always() 
      run: |
        git config --global user.name 'RSS Monitor Bot'
        git config --global user.email 'bot@noreply.github.com'
        # 检查 articles.db 是否有变化
        if [[ -n $(git status --porcelain articles.db) ]]; then
          git add articles.db
          git commit -m "Update articles database [skip ci]"
          git pull --rebase
          git push
        else
          echo "No changes to database"
        fi
